#!/bin/bash
#
# Git pre-commit hook for RC Submarine Controller
#
# This hook runs quick checks before each commit:
# 1. Format validation (tabs, trailing whitespace)
# 2. Power of 10 compliance on changed files
# 3. cppcheck on changed files (if installed)
#
# Install with: ./ci/install_hooks.sh
# Bypass with:  git commit --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get the project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
CI_DIR="$PROJECT_ROOT/ci"

# Get list of staged C/H files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h)$' || true)

if [[ -z "$STAGED_FILES" ]]; then
    echo -e "${GREEN}No C/H files staged, skipping checks${NC}"
    exit 0
fi

echo "Checking files:"
echo "$STAGED_FILES" | sed 's/^/  /'

ERRORS=0

#------------------------------------------------------------------------------
# Check 1: Formatting
#------------------------------------------------------------------------------

echo ""
echo -e "${YELLOW}[1/3] Checking formatting...${NC}"

for file in $STAGED_FILES; do
    # Check for tabs
    if grep -n $'\t' "$PROJECT_ROOT/$file" > /dev/null 2>&1; then
        echo -e "${RED}  ✗ $file contains tabs${NC}"
        ERRORS=$((ERRORS + 1))
    fi
    
    # Check for trailing whitespace
    if grep -n ' $' "$PROJECT_ROOT/$file" > /dev/null 2>&1; then
        echo -e "${RED}  ✗ $file has trailing whitespace${NC}"
        ERRORS=$((ERRORS + 1))
    fi
    
    # Check for CRLF
    if file "$PROJECT_ROOT/$file" | grep -q CRLF 2>/dev/null; then
        echo -e "${RED}  ✗ $file has CRLF line endings${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

if [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}  ✓ Formatting OK${NC}"
fi

#------------------------------------------------------------------------------
# Check 2: Power of 10 compliance
#------------------------------------------------------------------------------

echo ""
echo -e "${YELLOW}[2/3] Checking Power of 10 compliance...${NC}"

P10_CHECKER="$CI_DIR/p10_check.py"

if [[ -f "$P10_CHECKER" ]]; then
    for file in $STAGED_FILES; do
        # Only check .c files (headers are checked when included)
        if [[ "$file" == *.c ]]; then
            if ! python3 "$P10_CHECKER" "$PROJECT_ROOT/$file" 2>/dev/null; then
                ERRORS=$((ERRORS + 1))
            fi
        fi
    done
else
    echo -e "${YELLOW}  ○ P10 checker not found, skipping${NC}"
fi

#------------------------------------------------------------------------------
# Check 3: Static analysis (cppcheck)
#------------------------------------------------------------------------------

echo ""
echo -e "${YELLOW}[3/3] Running static analysis...${NC}"

if command -v cppcheck &> /dev/null; then
    for file in $STAGED_FILES; do
        if ! cppcheck --quiet --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            "$PROJECT_ROOT/$file" 2>&1; then
            ERRORS=$((ERRORS + 1))
        fi
    done
    echo -e "${GREEN}  ✓ Static analysis OK${NC}"
else
    echo -e "${YELLOW}  ○ cppcheck not installed, skipping${NC}"
    if [[ "$(uname)" == "Darwin" ]]; then
        echo "    Install with: brew install cppcheck"
    else
        echo "    Install with: sudo apt install cppcheck"
    fi
fi

#------------------------------------------------------------------------------
# Summary
#------------------------------------------------------------------------------

echo ""
if [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  ✓ Pre-commit checks passed${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════════════${NC}"
    exit 0
else
    echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
    echo -e "${RED}  ✗ Pre-commit checks failed ($ERRORS errors)${NC}"
    echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Fix the issues above, then try again."
    echo "To bypass this check (not recommended): git commit --no-verify"
    exit 1
fi
